<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Financier Tenex</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tabs {
            display: flex;
            gap: 5px;
        }

        .tab {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #dee2e6;
        }

        .save-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .tab-content {
            background: white;
            min-height: calc(100vh - 200px);
            padding: 20px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }

        .section.marketing {
            border-left-color: #e83e8c;
        }

        .section h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .section.marketing h3 {
            color: #e83e8c;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: #007bff;
            color: white;
            font-weight: 600;
        }

        .table.marketing th {
            background: #e83e8c;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .calculated-cell {
            background: #d4edda;
            padding: 5px;
            text-align: right;
            font-weight: 600;
        }

        .marketing-calculated {
            background: #f8d7da;
            padding: 5px;
            text-align: right;
            font-weight: 600;
            color: #721c24;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-container h4 {
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid #007bff;
        }

        .kpi-card h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kpi-card .value {
            font-size: 2em;
            font-weight: 700;
            color: #007bff;
        }

        .kpi-card.positive .value {
            color: #28a745;
        }

        .kpi-card.negative .value {
            color: #dc3545;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }

        .share-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .share-url {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
            margin: 10px 0;
        }

        .marketing-table {
            font-size: 12px;
        }

        .marketing-table input {
            width: 80px;
            padding: 5px;
            font-size: 11px;
        }

        .marketing-table .calculated-cell {
            background: #fdf2e0;
            color: #856404;
            font-size: 11px;
        }

        .compact-input {
            width: 70px !important;
            padding: 4px !important;
            font-size: 11px !important;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tabs {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .save-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Simulateur Financier Tenex</h1>
        <p>Jobboard SaaS - M√©tiers supports en √éle-de-France</p>
    </div>

    <div class="controls">
        <div class="tabs">
            <button class="tab active" onclick="showTab('hypotheses')">üìù Hypoth√®ses</button>
            <button class="tab" onclick="showTab('simulation')">üìà Simulation</button>
            <button class="tab" onclick="showTab('dashboard')">üìä KPI Dashboard</button>
            <button class="tab" onclick="showTab('historique')">üíæ Historique</button>
        </div>
        <div class="save-controls">
            <button class="btn btn-success" onclick="sauvegarder()">üíæ Sauvegarder</button>
            <button class="btn btn-warning" onclick="generateShareLink()">üîó Partager</button>
            <button class="btn btn-primary" onclick="exportData()">üì• Exporter</button>
            <input type="file" id="importFile" accept=".json" style="display: none" onchange="importData(event)">
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Importer</button>
        </div>
    </div>

    <!-- Indicateur de sauvegarde automatique -->
    <div id="autoSaveIndicator" class="auto-save-indicator">üíæ Sauvegarde automatique...</div>

    <div class="tab-content">
        <!-- ONGLET HYPOTHESES -->
        <div class="tab-pane active" id="hypotheses">
            <div class="alert alert-info">
                <strong>üí° Instructions :</strong> Remplissez les champs avec vos hypoth√®ses business. Les calculs se mettent √† jour automatiquement et vos donn√©es seront sauvegard√©es automatiquement.
            </div>

            <!-- Section de partage -->
            <div class="share-section" id="shareSection" style="display: none;">
                <h4>üîó Lien de partage g√©n√©r√©</h4>
                <p>Copiez ce lien pour acc√©der √† votre configuration depuis n'importe quel ordinateur :</p>
                <div class="share-url" id="shareUrl"></div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-primary" onclick="copyShareLink()">üìã Copier le lien</button>
                    <button class="btn btn-secondary" onclick="hideShareSection()">‚úñ Fermer</button>
                </div>
            </div>

            <div class="section">
                <h3>üí∞ Configuration des Offres</h3>
                <table class="table">
                    <thead>
                        <tr style="background: #007bff; color: white;">
                            <th>Offre</th>
                            <th>Prix mensuel (‚Ç¨)</th>
                            <th>Clients actuels</th>
                            <th>Objectif clients M12</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="offresTable">
                        <tr>
                            <td><input type="text" value="Starter" id="nom_offre_1" onchange="updateCalculations()"></td>
                            <td><input type="number" value="49" id="prix_offre_1" onchange="updateCalculations()"></td>
                            <td><input type="number" value="15" id="clients_actuels_offre_1" onchange="updateCalculations()"></td>
                            <td><input type="number" value="50" id="objectif_offre_1" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerOffre(1)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Standard" id="nom_offre_2" onchange="updateCalculations()"></td>
                            <td><input type="number" value="149" id="prix_offre_2" onchange="updateCalculations()"></td>
                            <td><input type="number" value="8" id="clients_actuels_offre_2" onchange="updateCalculations()"></td>
                            <td><input type="number" value="30" id="objectif_offre_2" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerOffre(2)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Premium" id="nom_offre_3" onchange="updateCalculations()"></td>
                            <td><input type="number" value="299" id="prix_offre_3" onchange="updateCalculations()"></td>
                            <td><input type="number" value="2" id="clients_actuels_offre_3" onchange="updateCalculations()"></td>
                            <td><input type="number" value="15" id="objectif_offre_3" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerOffre(3)">üóëÔ∏è</button></td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="ajouterOffre()">‚ûï Ajouter une offre</button>
            </div>

            <!-- NOUVELLE SECTION MARKETING AVANC√â -->
            <div class="section marketing">
                <h3>üéØ Campagnes Marketing & Leviers d'Acquisition</h3>
                <div class="alert alert-warning">
                    <strong>üöÄ Nouveau :</strong> G√©rez vos campagnes marketing avec des m√©triques d√©taill√©es (impressions, clics, conversions, ROI...). Les m√©triques calcul√©es automatiquement s'int√®grent dans votre simulation globale.
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="table marketing marketing-table">
                        <thead>
                            <tr>
                                <th>Campagne / Levier</th>
                                <th>Budget (‚Ç¨/mois)</th>
                                <th>Impressions</th>
                                <th>Clics</th>
                                <th>CPC (‚Ç¨)</th>
                                <th>Visites</th>
                                <th>Leads</th>
                                <th>CPL (‚Ç¨)</th>
                                <th>Abonnements</th>
                                <th>Inscriptions</th>
                                <th>CAC (‚Ç¨)</th>
                                <th>Revenus (‚Ç¨/mois)</th>
                                <th>ROI (%)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="campagnesTable">
                            <tr>
                                <td><input type="text" value="Google Ads" id="nom_campagne_1" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="3000" id="budget_campagne_1" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="500000" id="impressions_campagne_1" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="5000" id="clics_campagne_1" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cpc_campagne_1">‚Ç¨0.60</span></td>
                                <td><input type="number" value="4500" id="visites_campagne_1" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="450" id="leads_campagne_1" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cpl_campagne_1">‚Ç¨6.67</span></td>
                                <td><input type="number" value="54" id="abonnements_campagne_1" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="45" id="inscriptions_campagne_1" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cac_campagne_1">‚Ç¨66.67</span></td>
                                <td><span class="marketing-calculated" id="revenus_campagne_1">‚Ç¨7425</span></td>
                                <td><span class="marketing-calculated" id="roi_campagne_1">147.5%</span></td>
                                <td><button class="btn btn-danger btn-sm" onclick="supprimerCampagne(1)">üóëÔ∏è</button></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="Facebook Ads" id="nom_campagne_2" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="2000" id="budget_campagne_2" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="800000" id="impressions_campagne_2" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="4000" id="clics_campagne_2" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cpc_campagne_2">‚Ç¨0.50</span></td>
                                <td><input type="number" value="3600" id="visites_campagne_2" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="288" id="leads_campagne_2" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cpl_campagne_2">‚Ç¨6.94</span></td>
                                <td><input type="number" value="29" id="abonnements_campagne_2" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="25" id="inscriptions_campagne_2" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cac_campagne_2">‚Ç¨80.00</span></td>
                                <td><span class="marketing-calculated" id="revenus_campagne_2">‚Ç¨4117</span></td>
                                <td><span class="marketing-calculated" id="roi_campagne_2">105.8%</span></td>
                                <td><button class="btn btn-danger btn-sm" onclick="supprimerCampagne(2)">üóëÔ∏è</button></td>
                            </tr>
                            <tr>
                                <td><input type="text" value="LinkedIn Ads" id="nom_campagne_3" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="1500" id="budget_campagne_3" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="200000" id="impressions_campagne_3" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="1500" id="clics_campagne_3" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cpc_campagne_3">‚Ç¨1.00</span></td>
                                <td><input type="number" value="1350" id="visites_campagne_3" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="203" id="leads_campagne_3" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cpl_campagne_3">‚Ç¨7.39</span></td>
                                <td><input type="number" value="20" id="abonnements_campagne_3" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><input type="number" value="18" id="inscriptions_campagne_3" class="compact-input" onchange="updateMarketingCalculations()"></td>
                                <td><span class="marketing-calculated" id="cac_campagne_3">‚Ç¨83.33</span></td>
                                <td><span class="marketing-calculated" id="revenus_campagne_3">‚Ç¨2598</span></td>
                                <td><span class="marketing-calculated" id="roi_campagne_3">73.2%</span></td>
                                <td><button class="btn btn-danger btn-sm" onclick="supprimerCampagne(3)">üóëÔ∏è</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-primary" onclick="ajouterCampagne()">‚ûï Ajouter une campagne marketing</button>
                
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üìä Totaux Marketing</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div><strong>Budget total:</strong> <span id="total_budget_marketing">‚Ç¨6,500</span></div>
                        <div><strong>Total leads:</strong> <span id="total_leads_marketing">941</span></div>
                        <div><strong>Total abonnements:</strong> <span id="total_abonnements_marketing">103</span></div>
                        <div><strong>CAC moyen:</strong> <span id="cac_moyen_marketing">‚Ç¨63.11</span></div>
                        <div><strong>Total revenus:</strong> <span id="total_revenus_marketing">‚Ç¨14,140</span></div>
                        <div><strong>ROI global:</strong> <span id="roi_global_marketing">117.5%</span></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üìà Croissance & Churn</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Taux de churn mensuel (%)</label>
                        <input type="number" id="churn_mensuel" value="5" step="0.1" onchange="updateCalculations()">
                    </div>
                    <div class="form-group">
                        <label>Taux de conversion leads ‚Üí clients (%)</label>
                        <input type="number" id="taux_conversion" value="12" step="0.1" onchange="updateCalculations()">
                    </div>
                    <div class="form-group">
                        <label>Tr√©sorerie de d√©part (‚Ç¨)</label>
                        <input type="number" id="tresorerie_depart" value="50000" onchange="updateCalculations()">
                    </div>
                </div>
                <div class="alert alert-info" style="margin-top: 15px;">
                    <strong>‚ÑπÔ∏è Budget marketing automatique :</strong> Le budget marketing total est maintenant calcul√© automatiquement depuis vos campagnes ci-dessus (<span id="budget_auto_display">‚Ç¨6,500</span>/mois).
                </div>
            </div>

            <div class="section">
                <h3>üë®‚Äçüíª √âquipe & Salaires (‚Ç¨/mois)</h3>
                <div class="alert alert-info">
                    <strong>üí° Charges modulables :</strong> Ajoutez, modifiez ou supprimez des postes selon vos besoins.
                </div>
                <table class="table">
                    <thead>
                        <tr style="background: #28a745; color: white;">
                            <th>Poste</th>
                            <th>Montant mensuel (‚Ç¨)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salairesTable">
                        <tr>
                            <td><input type="text" value="CEO/Founder" id="nom_salaire_1"></td>
                            <td><input type="number" value="3500" id="montant_salaire_1" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('salairesTable', 1)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="CTO/Dev Lead" id="nom_salaire_2"></td>
                            <td><input type="number" value="4500" id="montant_salaire_2" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('salairesTable', 2)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="D√©veloppeur(s)" id="nom_salaire_3"></td>
                            <td><input type="number" value="6000" id="montant_salaire_3" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('salairesTable', 3)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="UI/UX Designer" id="nom_salaire_4"></td>
                            <td><input type="number" value="3200" id="montant_salaire_4" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('salairesTable', 4)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Marketing/Growth" id="nom_salaire_5"></td>
                            <td><input type="number" value="3500" id="montant_salaire_5" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('salairesTable', 5)">üóëÔ∏è</button></td>
                        </tr>
                    </tbody>
                </table>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="ajouterCharge('salairesTable', 'salaire')">‚ûï Ajouter un poste</button>
                    <label style="margin-left: 20px;">
                        Charges sociales (%):
                        <input type="number" id="charges_sociales_pct" value="45" step="0.1" onchange="updateCalculations()" style="width: 80px; margin-left: 10px;">
                    </label>
                </div>
            </div>

            <div class="section">
                <h3>üîß Outils & Logiciels (‚Ç¨/mois)</h3>
                <table class="table">
                    <thead>
                        <tr style="background: #6f42c1; color: white;">
                            <th>Outil/Service</th>
                            <th>Montant mensuel (‚Ç¨)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="outilsTable">
                        <tr>
                            <td><input type="text" value="H√©bergement (AWS/OVH)" id="nom_outil_1"></td>
                            <td><input type="number" value="450" id="montant_outil_1" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('outilsTable', 1)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Base de donn√©es" id="nom_outil_2"></td>
                            <td><input type="number" value="150" id="montant_outil_2" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('outilsTable', 2)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="CRM (HubSpot/Pipedrive)" id="nom_outil_3"></td>
                            <td><input type="number" value="89" id="montant_outil_3" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('outilsTable', 3)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Analytics (Mixpanel/Amplitude)" id="nom_outil_4"></td>
                            <td><input type="number" value="199" id="montant_outil_4" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('outilsTable', 4)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Support client (Intercom)" id="nom_outil_5"></td>
                            <td><input type="number" value="79" id="montant_outil_5" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('outilsTable', 5)">üóëÔ∏è</button></td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="ajouterCharge('outilsTable', 'outil')">‚ûï Ajouter un outil</button>
            </div>

            <div class="section">
                <h3>üè¢ Frais g√©n√©raux (‚Ç¨/mois)</h3>
                <table class="table">
                    <thead>
                        <tr style="background: #fd7e14; color: white;">
                            <th>Frais</th>
                            <th>Montant mensuel (‚Ç¨)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fraisTable">
                        <tr>
                            <td><input type="text" value="Bureau/Coworking" id="nom_frais_1"></td>
                            <td><input type="number" value="800" id="montant_frais_1" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('fraisTable', 1)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Internet & T√©l√©com" id="nom_frais_2"></td>
                            <td><input type="number" value="120" id="montant_frais_2" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('fraisTable', 2)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Assurances" id="nom_frais_3"></td>
                            <td><input type="number" value="180" id="montant_frais_3" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('fraisTable', 3)">üóëÔ∏è</button></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Juridique/Expert-comptable" id="nom_frais_4"></td>
                            <td><input type="number" value="350" id="montant_frais_4" onchange="updateCalculations()"></td>
                            <td><button class="btn btn-secondary" onclick="supprimerCharge('fraisTable', 4)">üóëÔ∏è</button></td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="ajouterCharge('fraisTable', 'frais')">‚ûï Ajouter des frais</button>
            </div>

            <div class="section">
                <h3>üí∞ Finances</h3>
                <div class="form-group" style="max-width: 300px;">
                    <label>Charges variables index√©es (% CA)</label>
                    <input type="number" id="charges_variables_pct" value="15" step="0.1" onchange="updateCalculations()">
                    <small style="color: #666;">Ex: commissions, frais bancaires, h√©bergement additionnel</small>
                </div>
            </div>
        </div>

        <!-- ONGLET SIMULATION -->
        <div class="tab-pane" id="simulation">
            <div class="alert alert-success">
                <strong>‚úÖ Calculs automatiques :</strong> Les donn√©es se mettent √† jour en temps r√©el selon vos hypoth√®ses et campagnes marketing.
            </div>

            <table class="table" id="simulationTable">
                <thead>
                    <tr>
                        <th>Mois</th>
                        <th>Clients actifs</th>
                        <th>Nouveaux clients</th>
                        <th>Clients perdus</th>
                        <th>MRR (‚Ç¨)</th>
                        <th>Budget Marketing (‚Ç¨)</th>
                        <th>Autres charges (‚Ç¨)</th>
                        <th>Charges totales (‚Ç¨)</th>
                        <th>R√©sultat net (‚Ç¨)</th>
                        <th>Cash restant (‚Ç¨)</th>
                    </tr>
                </thead>
                <tbody id="simulationBody">
                </tbody>
            </table>
        </div>

        <!-- ONGLET DASHBOARD -->
        <div class="tab-pane" id="dashboard">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <h4>MRR Final</h4>
                    <div class="value" id="kpi_mrr">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <h4>ARR</h4>
                    <div class="value" id="kpi_arr">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <h4>CAC Marketing</h4>
                    <div class="value" id="kpi_cac">‚Ç¨0</div>
                </div>
                <div class="kpi-card">
                    <h4>LTV/CAC Ratio</h4>
                    <div class="value" id="kpi_ltv_cac">0</div>
                </div>
                <div class="kpi-card">
                    <h4>Runway (mois)</h4>
                    <div class="value" id="kpi_runway">0</div>
                </div>
                <div class="kpi-card">
                    <h4>Break-even (mois)</h4>
                    <div class="value" id="kpi_breakeven">--</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h4>√âvolution MRR sur 12 mois</h4>
                    <canvas id="mrrChart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>R√©sultat net mensuel</h4>
                    <canvas id="margeChart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Croissance clients</h4>
                    <canvas id="clientsChart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Cash Flow</h4>
                    <canvas id="cashChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ONGLET HISTORIQUE -->
        <div class="tab-pane" id="historique">
            <div class="alert alert-info">
                <strong>üìö Historique des sauvegardes :</strong> Toutes vos configurations sont sauvegard√©es automatiquement et peuvent √™tre retrouv√©es ici m√™me apr√®s un refresh de page.
            </div>
            
            <div class="section">
                <h3>üóÇÔ∏è Sauvegardes r√©centes</h3>
                <div id="historiqueList">
                    <p>Aucune sauvegarde pour le moment. Cliquez sur "Sauvegarder" pour commencer.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let simulationData = [];
        let historiqueSauvegardes = [];
        let charts = {};
        let nextOffreId = 4;
        let nextChargeId = { salaire: 6, outil: 6, frais: 5 };
        let nextCampagneId = 4; // Pour les nouvelles campagnes

        // === FONCTIONS DE CAMPAGNES MARKETING ===
        
        // Ajouter une campagne
        function ajouterCampagne() {
            const table = document.getElementById('campagnesTable');
            const row = table.insertRow();
            const id = nextCampagneId++;
            
            row.innerHTML = `
                <td><input type="text" value="Nouvelle campagne" id="nom_campagne_${id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                <td><input type="number" value="1000" id="budget_campagne_${id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                <td><input type="number" value="100000" id="impressions_campagne_${id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                <td><input type="number" value="1000" id="clics_campagne_${id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                <td><span class="marketing-calculated" id="cpc_campagne_${id}">‚Ç¨1.00</span></td>
                <td><input type="number" value="900" id="visites_campagne_${id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                <td><input type="number" value="90" id="leads_campagne_${id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                <td><span class="marketing-calculated" id="cpl_campagne_${id}">‚Ç¨11.11</span></td>
                <td><input type="number" value="11" id="abonnements_campagne_${id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                <td><input type="number" value="10" id="inscriptions_campagne_${id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                <td><span class="marketing-calculated" id="cac_campagne_${id}">‚Ç¨100.00</span></td>
                <td><span class="marketing-calculated" id="revenus_campagne_${id}">‚Ç¨1500</span></td>
                <td><span class="marketing-calculated" id="roi_campagne_${id}">50.0%</span></td>
                <td><button class="btn btn-danger btn-sm" onclick="supprimerCampagne(${id})">üóëÔ∏è</button></td>
            `;
            updateMarketingCalculations();
        }

        // Supprimer une campagne
        function supprimerCampagne(id) {
            const row = document.getElementById(`nom_campagne_${id}`).closest('tr');
            row.remove();
            updateMarketingCalculations();
        }

        // R√©cup√©rer les campagnes actives
        function getCampagnesActives() {
            const campagnes = [];
            const table = document.getElementById('campagnesTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const nomInput = rows[i].querySelector('input[id^="nom_campagne_"]');
                const budgetInput = rows[i].querySelector('input[id^="budget_campagne_"]');
                const impressionsInput = rows[i].querySelector('input[id^="impressions_campagne_"]');
                const clicsInput = rows[i].querySelector('input[id^="clics_campagne_"]');
                const visitesInput = rows[i].querySelector('input[id^="visites_campagne_"]');
                const leadsInput = rows[i].querySelector('input[id^="leads_campagne_"]');
                const abonnementsInput = rows[i].querySelector('input[id^="abonnements_campagne_"]');
                const inscriptionsInput = rows[i].querySelector('input[id^="inscriptions_campagne_"]');
                
                if (nomInput && budgetInput) {
                    const id = nomInput.id.split('_').pop();
                    campagnes.push({
                        id,
                        nom: nomInput.value || `Campagne ${i + 1}`,
                        budget: parseFloat(budgetInput.value) || 0,
                        impressions: parseInt(impressionsInput.value) || 0,
                        clics: parseInt(clicsInput.value) || 0,
                        visites: parseInt(visitesInput.value) || 0,
                        leads: parseInt(leadsInput.value) || 0,
                        abonnements: parseInt(abonnementsInput.value) || 0,
                        inscriptions: parseInt(inscriptionsInput.value) || 0
                    });
                }
            }
            return campagnes;
        }

        // Calculer les m√©triques marketing pour une campagne
        function calculateCampagneMetrics(campagne) {
            const cpc = campagne.clics > 0 ? campagne.budget / campagne.clics : 0;
            const cpl = campagne.leads > 0 ? campagne.budget / campagne.leads : 0;
            const cac = campagne.abonnements > 0 ? campagne.budget / campagne.abonnements : 0;
            
            // Calculer les revenus estim√©s (ARPU moyen * abonnements)
            const arpuMoyen = calculateARPU();
            const revenus = campagne.abonnements * arpuMoyen;
            
            // ROI = ((Revenus - Co√ªts) / Co√ªts) * 100
            const roi = campagne.budget > 0 ? ((revenus - campagne.budget) / campagne.budget) * 100 : 0;
            
            return { cpc, cpl, cac, revenus, roi };
        }

        // Mettre √† jour les calculs marketing
        function updateMarketingCalculations() {
            const campagnes = getCampagnesActives();
            let totalBudget = 0;
            let totalLeads = 0;
            let totalAbonnements = 0;
            let totalRevenus = 0;
            
            campagnes.forEach(campagne => {
                const metrics = calculateCampagneMetrics(campagne);
                
                // Mettre √† jour l'affichage des m√©triques calcul√©es
                const cpcElement = document.getElementById(`cpc_campagne_${campagne.id}`);
                const cplElement = document.getElementById(`cpl_campagne_${campagne.id}`);
                const cacElement = document.getElementById(`cac_campagne_${campagne.id}`);
                const revenusElement = document.getElementById(`revenus_campagne_${campagne.id}`);
                const roiElement = document.getElementById(`roi_campagne_${campagne.id}`);
                
                if (cpcElement) cpcElement.textContent = `‚Ç¨${metrics.cpc.toFixed(2)}`;
                if (cplElement) cplElement.textContent = `‚Ç¨${metrics.cpl.toFixed(2)}`;
                if (cacElement) cacElement.textContent = `‚Ç¨${metrics.cac.toFixed(2)}`;
                if (revenusElement) revenusElement.textContent = `‚Ç¨${metrics.revenus.toLocaleString()}`;
                if (roiElement) {
                    roiElement.textContent = `${metrics.roi.toFixed(1)}%`;
                    roiElement.style.color = metrics.roi >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Accumuler les totaux
                totalBudget += campagne.budget;
                totalLeads += campagne.leads;
                totalAbonnements += campagne.abonnements;
                totalRevenus += metrics.revenus;
            });
            
            // Mettre √† jour les totaux marketing
            const cacMoyen = totalAbonnements > 0 ? totalBudget / totalAbonnements : 0;
            const roiGlobal = totalBudget > 0 ? ((totalRevenus - totalBudget) / totalBudget) * 100 : 0;
            
            document.getElementById('total_budget_marketing').textContent = `‚Ç¨${totalBudget.toLocaleString()}`;
            document.getElementById('total_leads_marketing').textContent = totalLeads.toLocaleString();
            document.getElementById('total_abonnements_marketing').textContent = totalAbonnements.toLocaleString();
            document.getElementById('cac_moyen_marketing').textContent = `‚Ç¨${cacMoyen.toFixed(2)}`;
            document.getElementById('total_revenus_marketing').textContent = `‚Ç¨${totalRevenus.toLocaleString()}`;
            document.getElementById('roi_global_marketing').textContent = `${roiGlobal.toFixed(1)}%`;
            
            // Mettre √† jour l'affichage du budget automatique
            document.getElementById('budget_auto_display').textContent = `‚Ç¨${totalBudget.toLocaleString()}`;
            
            // D√©clencher la mise √† jour des calculs globaux
            updateCalculations();
        }

        // === FONCTIONS DE PARTAGE URL ===
        
        // G√©n√©rer un lien de partage avec toutes les donn√©es
        function generateShareLink() {
            try {
                const currentState = {
                    offres: getOffresActives(),
                    charges: getAllCharges(),
                    campagnes: getCampagnesActives(), // Nouvelle section
                    params: getAllParams(),
                    v: '2.0' // Version mise √† jour
                };
                
                // Encoder en base64 pour l'URL
                const encodedData = btoa(JSON.stringify(currentState));
                
                // Cr√©er l'URL compl√®te
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?config=${encodedData}`;
                
                // Afficher la section de partage
                document.getElementById('shareUrl').textContent = shareUrl;
                document.getElementById('shareSection').style.display = 'block';
                
                // Scroll vers la section
                document.getElementById('shareSection').scrollIntoView({ behavior: 'smooth' });
                
                console.log('Lien de partage g√©n√©r√© avec campagnes marketing');
            } catch (error) {
                alert('Erreur lors de la g√©n√©ration du lien : ' + error.message);
                console.error('Erreur g√©n√©ration lien:', error);
            }
        }
        
        // Copier le lien de partage
        function copyShareLink() {
            const shareUrl = document.getElementById('shareUrl').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Lien copi√© dans le presse-papiers !');
                }).catch(() => {
                    // Fallback si clipboard API ne fonctionne pas
                    copyToClipboardFallback(shareUrl);
                });
            } else {
                copyToClipboardFallback(shareUrl);
            }
        }
        
        // Fallback pour copier le lien
        function copyToClipboardFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('Lien copi√© dans le presse-papiers !');
            } catch (err) {
                alert('Impossible de copier automatiquement. S√©lectionnez le texte et copiez-le manuellement.');
            }
            
            document.body.removeChild(textArea);
        }
        
        // Masquer la section de partage
        function hideShareSection() {
            document.getElementById('shareSection').style.display = 'none';
        }
        
        // Charger la configuration depuis l'URL
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');
            
            if (!configParam) {
                return false;
            }
            
            try {
                // D√©coder depuis base64
                const decodedData = atob(configParam);
                const state = JSON.parse(decodedData);
                
                console.log('Configuration trouv√©e dans l\'URL, version:', state.v || 'inconnue');
                
                // Restaurer les offres
                if (state.offres) {
                    restoreOffres(state.offres);
                    const maxId = Math.max(...state.offres.map(o => parseInt(o.id) || 0));
                    nextOffreId = maxId + 1;
                }
                
                // Restaurer les charges
                if (state.charges) {
                    restoreCharges(state.charges);
                }
                
                // Restaurer les campagnes marketing
                if (state.campagnes) {
                    restoreCampagnes(state.campagnes);
                    const maxCampagneId = Math.max(...state.campagnes.map(c => parseInt(c.id) || 0));
                    nextCampagneId = maxCampagneId + 1;
                }
                
                // Restaurer les param√®tres
                if (state.params) {
                    restoreParams(state.params);
                }
                
                // Afficher un message de confirmation
                setTimeout(() => {
                    if (confirm('Configuration charg√©e depuis le lien de partage. Voulez-vous sauvegarder localement cette configuration ?')) {
                        saveToLocalStorage();
                    }
                }, 1000);
                
                // Nettoyer l'URL (optionnel)
                if (history.replaceState) {
                    history.replaceState(null, '', window.location.pathname);
                }
                
                return true;
            } catch (error) {
                console.error('Erreur lors du chargement depuis l\'URL:', error);
                alert('Le lien de partage semble corrompu ou incompatible.');
                return false;
            }
        }

        // Restaurer les campagnes
        function restoreCampagnes(campagnes) {
            const table = document.getElementById('campagnesTable');
            table.innerHTML = '';
            
            campagnes.forEach(campagne => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${campagne.nom}" id="nom_campagne_${campagne.id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                    <td><input type="number" value="${campagne.budget}" id="budget_campagne_${campagne.id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                    <td><input type="number" value="${campagne.impressions}" id="impressions_campagne_${campagne.id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                    <td><input type="number" value="${campagne.clics}" id="clics_campagne_${campagne.id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                    <td><span class="marketing-calculated" id="cpc_campagne_${campagne.id}">‚Ç¨0.00</span></td>
                    <td><input type="number" value="${campagne.visites}" id="visites_campagne_${campagne.id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                    <td><input type="number" value="${campagne.leads}" id="leads_campagne_${campagne.id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                    <td><span class="marketing-calculated" id="cpl_campagne_${campagne.id}">‚Ç¨0.00</span></td>
                    <td><input type="number" value="${campagne.abonnements}" id="abonnements_campagne_${campagne.id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                    <td><input type="number" value="${campagne.inscriptions}" id="inscriptions_campagne_${campagne.id}" class="compact-input" onchange="updateMarketingCalculations()"></td>
                    <td><span class="marketing-calculated" id="cac_campagne_${campagne.id}">‚Ç¨0.00</span></td>
                    <td><span class="marketing-calculated" id="revenus_campagne_${campagne.id}">‚Ç¨0</span></td>
                    <td><span class="marketing-calculated" id="roi_campagne_${campagne.id}">0.0%</span></td>
                    <td><button class="btn btn-danger btn-sm" onclick="supprimerCampagne(${campagne.id})">üóëÔ∏è</button></td>
                `;
            });
        }

        // === FONCTIONS DE PERSISTANCE LOCALE ===
        
        // Sauvegarder l'√©tat actuel dans localStorage
        function saveToLocalStorage() {
            try {
                const currentState = {
                    offres: getOffresActives(),
                    charges: getAllCharges(),
                    campagnes: getCampagnesActives(), // Ajout des campagnes
                    params: getAllParams(),
                    historique: historiqueSauvegardes,
                    nextOffreId: nextOffreId,
                    nextChargeId: nextChargeId,
                    nextCampagneId: nextCampagneId, // Ajout nextCampagneId
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('tenex_simulator_state', JSON.stringify(currentState));
                
                // Afficher l'indicateur de sauvegarde
                showAutoSaveIndicator();
                
                console.log('√âtat sauvegard√© automatiquement avec campagnes marketing');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
            }
        }

        // Charger l'√©tat depuis localStorage
        function loadFromLocalStorage() {
            try {
                const savedState = localStorage.getItem('tenex_simulator_state');
                if (!savedState) {
                    console.log('Aucune sauvegarde locale trouv√©e');
                    return false;
                }

                const state = JSON.parse(savedState);
                
                // Restaurer les offres
                if (state.offres) {
                    restoreOffres(state.offres);
                }
                
                // Restaurer les charges
                if (state.charges) {
                    restoreCharges(state.charges);
                }
                
                // Restaurer les campagnes marketing
                if (state.campagnes) {
                    restoreCampagnes(state.campagnes);
                }
                
                // Restaurer les param√®tres
                if (state.params) {
                    restoreParams(state.params);
                }
                
                // Restaurer l'historique
                if (state.historique) {
                    historiqueSauvegardes = state.historique;
                    updateHistorique();
                }
                
                // Restaurer les IDs
                if (state.nextOffreId) {
                    nextOffreId = state.nextOffreId;
                }
                if (state.nextChargeId) {
                    nextChargeId = state.nextChargeId;
                }
                if (state.nextCampagneId) {
                    nextCampagneId = state.nextCampagneId;
                }
                
                console.log('√âtat restaur√© depuis localStorage du', new Date(state.lastSaved).toLocaleString('fr-FR'));
                return true;
            } catch (error) {
                console.error('Erreur lors du chargement local:', error);
                return false;
            }
        }

        // R√©cup√©rer toutes les charges actuelles
        function getAllCharges() {
            const charges = {
                salaires: [],
                outils: [],
                frais: []
            };

            // R√©cup√©rer les salaires
            const salairesTable = document.getElementById('salairesTable');
            Array.from(salairesTable.rows).forEach(row => {
                const nomInput = row.querySelector('input[id^="nom_salaire_"]');
                const montantInput = row.querySelector('input[id^="montant_salaire_"]');
                if (nomInput && montantInput) {
                    charges.salaires.push({
                        id: nomInput.id.split('_').pop(),
                        nom: nomInput.value,
                        montant: parseFloat(montantInput.value) || 0
                    });
                }
            });

            // R√©cup√©rer les outils
            const outilsTable = document.getElementById('outilsTable');
            Array.from(outilsTable.rows).forEach(row => {
                const nomInput = row.querySelector('input[id^="nom_outil_"]');
                const montantInput = row.querySelector('input[id^="montant_outil_"]');
                if (nomInput && montantInput) {
                    charges.outils.push({
                        id: nomInput.id.split('_').pop(),
                        nom: nomInput.value,
                        montant: parseFloat(montantInput.value) || 0
                    });
                }
            });

            // R√©cup√©rer les frais
            const fraisTable = document.getElementById('fraisTable');
            Array.from(fraisTable.rows).forEach(row => {
                const nomInput = row.querySelector('input[id^="nom_frais_"]');
                const montantInput = row.querySelector('input[id^="montant_frais_"]');
                if (nomInput && montantInput) {
                    charges.frais.push({
                        id: nomInput.id.split('_').pop(),
                        nom: nomInput.value,
                        montant: parseFloat(montantInput.value) || 0
                    });
                }
            });

            return charges;
        }

        // Restaurer toutes les charges
        function restoreCharges(charges) {
            if (charges.salaires) {
                const salairesTable = document.getElementById('salairesTable');
                salairesTable.innerHTML = '';
                charges.salaires.forEach(charge => {
                    const row = salairesTable.insertRow();
                    row.innerHTML = `
                        <td><input type="text" value="${charge.nom}" id="nom_salaire_${charge.id}"></td>
                        <td><input type="number" value="${charge.montant}" id="montant_salaire_${charge.id}" onchange="updateCalculations()"></td>
                        <td><button class="btn btn-secondary" onclick="supprimerCharge('salairesTable', ${charge.id})">üóëÔ∏è</button></td>
                    `;
                });
            }

            if (charges.outils) {
                const outilsTable = document.getElementById('outilsTable');
                outilsTable.innerHTML = '';
                charges.outils.forEach(charge => {
                    const row = outilsTable.insertRow();
                    row.innerHTML = `
                        <td><input type="text" value="${charge.nom}" id="nom_outil_${charge.id}"></td>
                        <td><input type="number" value="${charge.montant}" id="montant_outil_${charge.id}" onchange="updateCalculations()"></td>
                        <td><button class="btn btn-secondary" onclick="supprimerCharge('outilsTable', ${charge.id})">üóëÔ∏è</button></td>
                    `;
                });
            }

            if (charges.frais) {
                const fraisTable = document.getElementById('fraisTable');
                fraisTable.innerHTML = '';
                charges.frais.forEach(charge => {
                    const row = fraisTable.insertRow();
                    row.innerHTML = `
                        <td><input type="text" value="${charge.nom}" id="nom_frais_${charge.id}"></td>
                        <td><input type="number" value="${charge.montant}" id="montant_frais_${charge.id}" onchange="updateCalculations()"></td>
                        <td><button class="btn btn-secondary" onclick="supprimerCharge('fraisTable', ${charge.id})">üóëÔ∏è</button></td>
                    `;
                });
            }
        }

        // R√©cup√©rer tous les param√®tres actuels
        function getAllParams() {
            return {
                churn_mensuel: document.getElementById('churn_mensuel').value,
                taux_conversion: document.getElementById('taux_conversion').value,
                tresorerie_depart: document.getElementById('tresorerie_depart').value,
                charges_sociales_pct: document.getElementById('charges_sociales_pct').value,
                charges_variables_pct: document.getElementById('charges_variables_pct').value
            };
        }

        // Restaurer tous les param√®tres
        function restoreParams(params) {
            Object.keys(params).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = params[key];
                }
            });
        }

        // Restaurer les offres
        function restoreOffres(offres) {
            // Vider le tableau actuel
            const table = document.getElementById('offresTable');
            table.innerHTML = '';
            
            // Restaurer chaque offre
            offres.forEach(offre => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${offre.nom}" id="nom_offre_${offre.id}" onchange="updateCalculations()"></td>
                    <td><input type="number" value="${offre.prix}" id="prix_offre_${offre.id}" onchange="updateCalculations()"></td>
                    <td><input type="number" value="${offre.clientsActuels}" id="clients_actuels_offre_${offre.id}" onchange="updateCalculations()"></td>
                    <td><input type="number" value="${offre.objectif}" id="objectif_offre_${offre.id}" onchange="updateCalculations()"></td>
                    <td><button class="btn btn-secondary" onclick="supprimerOffre(${offre.id})">üóëÔ∏è</button></td>
                `;
            });
        }

        // Afficher l'indicateur de sauvegarde automatique
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // === FONCTIONS PRINCIPALES ===

        // Fonction pour obtenir les offres actives
        function getOffresActives() {
            const offres = [];
            const table = document.getElementById('offresTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const nomInput = rows[i].querySelector('input[id^="nom_offre_"]');
                const prixInput = rows[i].querySelector('input[id^="prix_offre_"]');
                const clientsActuelsInput = rows[i].querySelector('input[id^="clients_actuels_offre_"]');
                const objectifInput = rows[i].querySelector('input[id^="objectif_offre_"]');
                
                if (nomInput && prixInput && clientsActuelsInput) {
                    offres.push({
                        id: nomInput.id.split('_').pop(),
                        nom: nomInput.value || `Offre ${i + 1}`,
                        prix: parseFloat(prixInput.value) || 0,
                        clientsActuels: parseInt(clientsActuelsInput.value) || 0,
                        objectif: parseInt(objectifInput.value) || 0
                    });
                }
            }
            return offres;
        }

        // Ajouter une offre
        function ajouterOffre() {
            const table = document.getElementById('offresTable');
            const row = table.insertRow();
            const id = nextOffreId++;
            
            row.innerHTML = `
                <td><input type="text" value="Nouvelle offre" id="nom_offre_${id}" onchange="updateCalculations()"></td>
                <td><input type="number" value="99" id="prix_offre_${id}" onchange="updateCalculations()"></td>
                <td><input type="number" value="0" id="clients_actuels_offre_${id}" onchange="updateCalculations()"></td>
                <td><input type="number" value="10" id="objectif_offre_${id}" onchange="updateCalculations()"></td>
                <td><button class="btn btn-secondary" onclick="supprimerOffre(${id})">üóëÔ∏è</button></td>
            `;
            updateCalculations();
        }

        // Supprimer une offre
        function supprimerOffre(id) {
            const row = document.getElementById(`nom_offre_${id}`).closest('tr');
            row.remove();
            updateCalculations();
        }

        // Ajouter une charge
        function ajouterCharge(tableId, type) {
            const table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            const row = table.insertRow();
            const id = nextChargeId[type]++;
            
            row.innerHTML = `
                <td><input type="text" value="Nouveau ${type}" id="nom_${type}_${id}"></td>
                <td><input type="number" value="100" id="montant_${type}_${id}" onchange="updateCalculations()"></td>
                <td><button class="btn btn-secondary" onclick="supprimerCharge('${tableId}', ${id})">üóëÔ∏è</button></td>
            `;
            
            updateCalculations();
        }

        // Supprimer une charge
        function supprimerCharge(tableId, id) {
            const tables = {
                'salairesTable': 'salaire',
                'outilsTable': 'outil', 
                'fraisTable': 'frais'
            };
            const type = tables[tableId];
            const row = document.getElementById(`nom_${type}_${id}`).closest('tr');
            row.remove();
            updateCalculations();
        }

        // Afficher un onglet
        function showTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'dashboard') {
                setTimeout(() => updateCharts(), 100);
            }
        }

        // Calculer les charges fixes
        function calculateChargesFixes() {
            // Salaires √©quipe
            let totalSalaires = 0;
            const salairesTable = document.getElementById('salairesTable');
            const salairesRows = salairesTable.getElementsByTagName('tr');
            
            for (let i = 0; i < salairesRows.length; i++) {
                const montantInput = salairesRows[i].querySelector('input[id^="montant_salaire_"]');
                if (montantInput) {
                    totalSalaires += parseFloat(montantInput.value) || 0;
                }
            }
            
            const chargesSociales = totalSalaires * ((parseFloat(document.getElementById('charges_sociales_pct').value) || 0) / 100);
            const totalSalairesAvecCharges = totalSalaires + chargesSociales;

            // Outils & logiciels
            let outilsLogiciels = 0;
            const outilsTable = document.getElementById('outilsTable');
            const outilsRows = outilsTable.getElementsByTagName('tr');
            
            for (let i = 0; i < outilsRows.length; i++) {
                const montantInput = outilsRows[i].querySelector('input[id^="montant_outil_"]');
                if (montantInput) {
                    outilsLogiciels += parseFloat(montantInput.value) || 0;
                }
            }

            // Frais g√©n√©raux
            let fraisGeneraux = 0;
            const fraisTable = document.getElementById('fraisTable');
            const fraisRows = fraisTable.getElementsByTagName('tr');
            
            for (let i = 0; i < fraisRows.length; i++) {
                const montantInput = fraisRows[i].querySelector('input[id^="montant_frais_"]');
                if (montantInput) {
                    fraisGeneraux += parseFloat(montantInput.value) || 0;
                }
            }

            return {
                totalSalaires: totalSalairesAvecCharges,
                outilsLogiciels,
                fraisGeneraux,
                total: totalSalairesAvecCharges + outilsLogiciels + fraisGeneraux
            };
        }

        // Calculer l'ARPU moyen
        function calculateARPU() {
            const offres = getOffresActives();
            let totalClients = 0;
            let totalCA = 0;
            
            offres.forEach(offre => {
                totalClients += offre.clientsActuels;
                totalCA += offre.prix * offre.clientsActuels;
            });
            
            return totalClients > 0 ? totalCA / totalClients : 0;
        }

        // Calculer le budget marketing total depuis les campagnes
        function calculateBudgetMarketingTotal() {
            const campagnes = getCampagnesActives();
            return campagnes.reduce((total, campagne) => total + campagne.budget, 0);
        }

        // Mettre √† jour tous les calculs
        function updateCalculations() {
            const offres = getOffresActives();
            
            if (offres.length === 0) {
                simulationData = [];
                updateSimulationTable();
                return;
            }

            const params = {
                churnMensuel: parseFloat(document.getElementById('churn_mensuel').value) / 100 || 0.05,
                budgetMarketing: calculateBudgetMarketingTotal(), // Calcul√© depuis les campagnes
                tauxConversion: parseFloat(document.getElementById('taux_conversion').value) / 100 || 0.12,
                tresorerieDepart: parseFloat(document.getElementById('tresorerie_depart').value) || 0,
                chargesVariablesPct: parseFloat(document.getElementById('charges_variables_pct').value) / 100 || 0.15
            };

            const chargesFixes = calculateChargesFixes();
            simulationData = [];
            let tresorerie = params.tresorerieDepart;
            
            let clientsParOffre = {};
            offres.forEach(offre => {
                clientsParOffre[offre.id] = offre.clientsActuels;
            });

            for (let mois = 1; mois <= 12; mois++) {
                let totalClientsActifs = 0;
                let caMensuel = 0;
                let nouveauxClientsTotal = 0;
                let clientsPerdusTotal = 0;

                offres.forEach(offre => {
                    const clientsActuels = clientsParOffre[offre.id];
                    const clientsPerdus = Math.floor(clientsActuels * params.churnMensuel);
                    
                    const croissanceNecessaire = (offre.objectif - offre.clientsActuels) / 12;
                    const nouveauxClients = Math.max(0, Math.round(croissanceNecessaire + clientsPerdus));
                    
                    clientsParOffre[offre.id] = clientsActuels + nouveauxClients - clientsPerdus;
                    totalClientsActifs += clientsParOffre[offre.id];
                    caMensuel += clientsParOffre[offre.id] * offre.prix;
                    nouveauxClientsTotal += nouveauxClients;
                    clientsPerdusTotal += clientsPerdus;
                });

                const chargesVariables = caMensuel * params.chargesVariablesPct;
                const chargesTotales = chargesFixes.total + chargesVariables + params.budgetMarketing;
                const autresCharges = chargesFixes.total + chargesVariables;
                const resultatNet = caMensuel - chargesTotales;
                tresorerie += resultatNet;

                simulationData.push({
                    mois,
                    nouveauxClients: nouveauxClientsTotal,
                    clientsPerdus: clientsPerdusTotal,
                    clientsActifs: totalClientsActifs,
                    mrr: caMensuel,
                    budgetMarketing: params.budgetMarketing,
                    autresCharges: autresCharges,
                    chargesTotales,
                    resultatNet,
                    tresorerie
                });
            }

            updateSimulationTable();
            updateKPI();
            
            // Sauvegarde automatique apr√®s chaque modification
            saveToLocalStorage();
        }

        // Mettre √† jour le tableau de simulation
        function updateSimulationTable() {
            const tbody = document.getElementById('simulationBody');
            tbody.innerHTML = '';

            simulationData.forEach(data => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>M${data.mois}</strong></td>
                    <td class="calculated-cell">${data.clientsActifs}</td>
                    <td class="calculated-cell" style="color: #28a745">+${data.nouveauxClients}</td>
                    <td class="calculated-cell" style="color: #dc3545">-${data.clientsPerdus}</td>
                    <td class="calculated-cell">‚Ç¨${data.mrr.toLocaleString()}</td>
                    <td class="marketing-calculated">‚Ç¨${data.budgetMarketing.toLocaleString()}</td>
                    <td>‚Ç¨${data.autresCharges.toLocaleString()}</td>
                    <td>‚Ç¨${data.chargesTotales.toLocaleString()}</td>
                    <td class="calculated-cell" style="color: ${data.resultatNet >= 0 ? 'green' : 'red'}">
                        ‚Ç¨${data.resultatNet.toLocaleString()}
                    </td>
                    <td class="calculated-cell" style="color: ${data.tresorerie >= 0 ? 'green' : 'red'}">
                        ‚Ç¨${data.tresorerie.toLocaleString()}
                    </td>
                `;
            });
        }

        // Mettre √† jour les KPI
        function updateKPI() {
            if (simulationData.length === 0) return;

            const dernierMois = simulationData[simulationData.length - 1];
            const budgetMarketing = calculateBudgetMarketingTotal();

            document.getElementById('kpi_mrr').textContent = `‚Ç¨${dernierMois.mrr.toLocaleString()}`;
            document.getElementById('kpi_arr').textContent = `‚Ç¨${(dernierMois.mrr * 12).toLocaleString()}`;

            // CAC depuis les campagnes marketing
            const campagnes = getCampagnesActives();
            const totalAbonnements = campagnes.reduce((sum, c) => sum + c.abonnements, 0);
            const cacMarketing = totalAbonnements > 0 ? budgetMarketing / totalAbonnements : 0;
            document.getElementById('kpi_cac').textContent = `‚Ç¨${cacMarketing.toFixed(0)}`;

            const churnMensuel = parseFloat(document.getElementById('churn_mensuel').value) / 100 || 0.05;
            const arpuMoyen = calculateARPU();
            const ltv = churnMensuel > 0 ? arpuMoyen / churnMensuel : arpuMoyen * 20;
            const ltvCacRatio = cacMarketing > 0 ? ltv / cacMarketing : 0;
            document.getElementById('kpi_ltv_cac').textContent = ltvCacRatio.toFixed(1);

            const runwayMois = simulationData.findIndex(data => data.tresorerie <= 0);
            document.getElementById('kpi_runway').textContent = runwayMois === -1 ? '12+' : runwayMois;

            const breakEvenMois = simulationData.findIndex(data => data.resultatNet >= 0);
            document.getElementById('kpi_breakeven').textContent = breakEvenMois === -1 ? '12+' : breakEvenMois + 1;
        }

        // Mettre √† jour les graphiques
        function updateCharts() {
            if (simulationData.length === 0) return;

            const mois = simulationData.map(d => `M${d.mois}`);
            const mrr = simulationData.map(d => d.mrr);
            const clientsActifs = simulationData.map(d => d.clientsActifs);
            const resultatNet = simulationData.map(d => d.resultatNet);
            const tresorerie = simulationData.map(d => d.tresorerie);

            // Graphique MRR
            if (charts.mrr) charts.mrr.destroy();
            const ctxMrr = document.getElementById('mrrChart').getContext('2d');
            charts.mrr = new Chart(ctxMrr, {
                type: 'line',
                data: {
                    labels: mois,
                    datasets: [{
                        label: 'MRR (‚Ç¨)',
                        data: mrr,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Graphique Marge
            if (charts.marge) charts.marge.destroy();
            const ctxMarge = document.getElementById('margeChart').getContext('2d');
            charts.marge = new Chart(ctxMarge, {
                type: 'bar',
                data: {
                    labels: mois,
                    datasets: [{
                        label: 'R√©sultat net (‚Ç¨)',
                        data: resultatNet,
                        backgroundColor: resultatNet.map(v => v >= 0 ? '#28a745' : '#dc3545')
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Graphique Clients
            if (charts.clients) charts.clients.destroy();
            const ctxClients = document.getElementById('clientsChart').getContext('2d');
            charts.clients = new Chart(ctxClients, {
                type: 'line',
                data: {
                    labels: mois,
                    datasets: [{
                        label: 'Clients actifs',
                        data: clientsActifs,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Graphique Cash Flow
            if (charts.cash) charts.cash.destroy();
            const ctxCash = document.getElementById('cashChart').getContext('2d');
            charts.cash = new Chart(ctxCash, {
                type: 'line',
                data: {
                    labels: mois,
                    datasets: [{
                        label: 'Tr√©sorerie (‚Ç¨)',
                        data: tresorerie,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Sauvegarde et export
        function sauvegarder() {
            const config = {
                date: new Date().toLocaleString('fr-FR'),
                offres: getOffresActives(),
                charges: getAllCharges(),
                campagnes: getCampagnesActives(), // Ajout des campagnes
                params: getAllParams(),
                simulation: simulationData
            };
            historiqueSauvegardes.unshift(config);
            if (historiqueSauvegardes.length > 10) {
                historiqueSauvegardes.pop();
            }
            updateHistorique();
            saveToLocalStorage();
            alert('üíæ Configuration sauvegard√©e manuellement !');
        }

        function updateHistorique() {
            const historiqueList = document.getElementById('historiqueList');
            
            if (historiqueSauvegardes.length === 0) {
                historiqueList.innerHTML = '<p>Aucune sauvegarde pour le moment.</p>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Date</th><th>Offres</th><th>Campagnes</th><th>MRR Final</th></tr></thead><tbody>';
            
            historiqueSauvegardes.forEach(config => {
                const dernierMois = config.simulation[config.simulation.length - 1];
                const nbCampagnes = config.campagnes ? config.campagnes.length : 0;
                html += `
                    <tr>
                        <td>${config.date}</td>
                        <td>${config.offres.length} offres</td>
                        <td>${nbCampagnes} campagnes</td>
                        <td>‚Ç¨${dernierMois.mrr.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            historiqueList.innerHTML = html;
        }

        function exportData() {
            const data = {
                date: new Date().toISOString(),
                version: '2.0',
                etat_complet: {
                    offres: getOffresActives(),
                    charges: getAllCharges(),
                    campagnes: getCampagnesActives(), // Ajout des campagnes
                    params: getAllParams(),
                    historique: historiqueSauvegardes,
                    simulation: simulationData
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tenex_simulation_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('üì• Export r√©ussi !');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Import complet si disponible
                    if (data.etat_complet) {
                        if (data.etat_complet.offres) {
                            restoreOffres(data.etat_complet.offres);
                        }
                        if (data.etat_complet.charges) {
                            restoreCharges(data.etat_complet.charges);
                        }
                        if (data.etat_complet.campagnes) {
                            restoreCampagnes(data.etat_complet.campagnes);
                        }
                        if (data.etat_complet.params) {
                            restoreParams(data.etat_complet.params);
                        }
                        if (data.etat_complet.historique) {
                            historiqueSauvegardes = data.etat_complet.historique;
                            updateHistorique();
                        }
                    }
                    // Import historique seulement (ancienne version)
                    else if (data.historique) {
                        historiqueSauvegardes = data.historique;
                        updateHistorique();
                    }
                    
                    updateMarketingCalculations();
                    updateCalculations();
                    alert('üì§ Import r√©ussi !');
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // 1. D'abord essayer de charger depuis l'URL (priorit√©)
            const loadedFromURL = loadFromURL();
            
            // 2. Si pas de donn√©es dans l'URL, essayer localStorage
            if (!loadedFromURL) {
                const loadedFromLocal = loadFromLocalStorage();
                
                if (loadedFromLocal) {
                    console.log('‚úÖ Donn√©es restaur√©es depuis localStorage');
                } else {
                    console.log('‚ÑπÔ∏è D√©marrage avec les valeurs par d√©faut');
                }
            }
            
            // 3. Lancer les calculs marketing puis globaux
            updateMarketingCalculations();
            updateCalculations();
        });

        // Sauvegarder avant la fermeture de la page
        window.addEventListener('beforeunload', function() {
            saveToLocalStorage();
        });
    </script>
</body>
</html>